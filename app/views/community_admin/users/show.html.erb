<style>
  .overlay-container {
    position: relative;
  }

  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  .overlay-container a:not(.overlay),
  .overlay-container .btn {
    position: relative;
    z-index: 2;
  }

  .btn-ellipsis {
    color: #6c757d;
    background-color: transparent;
    background-image: none;
    border-color: transparent;
  }

  .btn-ellipsis:before {
    content: "•••";
    display: block;
    height: 1em;
    position: relative;
    top: -0.3em;
  }

  .btn-ellipsis:hover {
    border-color: #6c757d;
  }

  form.button_to input[type="submit"] {
    cursor: pointer;
  }
}
</style>

<%= render 'nav', active: :users %>

<div class="container">
  <div class="row justify-content-md-center">
    <div class="col-8">
      <div class="d-flex flex-nowrap mb-4">
        <div>
          <img class="rounded-circle"
               width="150" height="150"
               src="<%= UserServices::Avatar.new(user: @user).thumbnail_url %>"
               style="display: inline-block; background-image: url('<%= asset_path 'user/default_avatar.png' %>'); background-size: contain; background-color: #fff;"
               alt="">
        </div>
        <div class="ml-4 flex-grow-1">
          <h2><%= @user.first_name %><br><%= @user.last_name %></h2>
          <div class="mb-2">
            <div><%= link_to (@user.phone || ''), "tel:#{@user.phone}" %></div>
            <div><%= link_to (@user.email || ''), "mailto:#{@user.email}" %></div>
          </div>
          <div class="h5">
            <% @user.roles.sort_by { |r| current_user.community.roles.index(r) }
                       .each do |role| %>
              <% role_color = CommunityAdminService.role_color(community, role) %>
              <% next if role_color.nil? %>
              <span class="badge badge-<%= role_color %>"><%= t "community.#{community.slug}.roles.#{role}" %></span>
            <% end %>
          </div>
        </div>
        <div class="ml-4 h4">
          <a href="<%= edit_community_admin_user_path(@user) %>" class="btn btn-outline-secondary">Modifier le profil</a>
        </div>
      </div>

      <div>
        <table class="table table-hover mb-0">
        <thead>
          <tr>
            <td colspan="3" class="p-0 border-top-0">
              <h4>Voisinages</h4>
            </td>
          </tr>
          <% if @user_neighborhoods.empty? %>
            <td colspan="3" class="text-muted text-center">
              Cette personne n'appartient à aucun voisinage.
            </td>
          <% end %>
        </thead>

        <% lock_out_risk = @user == current_user && CommunityAdminService.leaving_neigborhood_will_lock_out(@user) %>
        <% @user_neighborhoods.each do |neighborhood| %>
          <% role = neighborhood.role.to_sym %>
          <tr class="overlay-container">
            <td>
              <%= link_to "", community_admin_neighborhood_path(neighborhood), class: "overlay" %>
              <%= neighborhood.title %>
            </td>
            <td>
              <% role_color = CommunityAdminService.role_color(community, role) %>
              <% unless role_color.nil? %>
                <span class="badge badge-<%= role_color %>"><%= t "community.#{community.slug}.roles.#{role}" %></span>
              <% end %>
            </td>
            <td class="text-right">
              <% if lock_out_risk && role == :coordinator %>

              <% else %>
                <div class="dropdown">
                  <span class="btn-sm btn btn-ellipsis" data-toggle="dropdown"></span>
                  <div class="dropdown-menu dropdown-menu-right">
                    <% if role == :coordinator %>
                      <%= button_to "Retirer le rôle d'animateur",
                            community_admin_user_neighborhood_role_path(@user,
                              neighborhood_id: neighborhood.id, role: :member),
                            method: :post,
                            class: "dropdown-item" %>
                    <% else %>
                      <%= button_to "Attribuer le rôle d'animateur",
                            community_admin_user_neighborhood_role_path(@user,
                              neighborhood_id: neighborhood.id, role: :coordinator),
                            method: :post,
                            class: "dropdown-item" %>
                    <% end %>
                    <%= button_to "Retirer du voisinage",
                          community_admin_user_neighborhoods_path(@user,
                            neighborhood_id: neighborhood.id),
                          method: :delete,
                          class: "dropdown-item text-danger" %>
                  </div>
                </div>
              <% end %>
            </td>
          </tr>
        <% end %>
        </table>

        <% if @user_neighborhoods.to_a.count == @coordinator_neighborhoods.count %>
        <% elsif params.key?(:add_neighborhood) %>
          <% user_neighborhood_ids = @user_neighborhoods.map(&:id) %>
          <div class="h4 mt-3 d-flex flex-nowrap">
            <span class="flex-grow-1">Ajouter à un voisinage</span>
            <a href="?" class="btn btn-outline-secondary btn-sm" style="margin-right: .75rem">Annuler</a>
          </div>
          <table class="table table-hover mb-0">
          <% @coordinator_neighborhoods.each do |neighborhood| %>
            <% next if neighborhood.id.in?(user_neighborhood_ids) %>
            <tr class="overlay-container">
              <td>
                <%= neighborhood.title %>
              </td>
              <td colspan="2" class="text-right py-0 align-middle">
                <%= button_to "Ajouter",
                      community_admin_user_neighborhoods_path(@user,
                        neighborhood_id: neighborhood.id),
                      method: :post,
                      class: "btn btn-outline-primary btn-sm" %>
              </td>
            </tr>
          <% end %>
          </table>
        <% else %>
          <div class="border-top text-right" style="padding: 12px 0">
            <a href="?add_neighborhood" class="btn btn-outline-secondary">
              <% if @user_neighborhoods.any? %>
                Ajouter à un autre voisinage
              <% else %>
                Ajouter à un voisinage
              <% end %>
            </a>
          </div>
        <% end %>

      </div>
    </div>
  </div>
</div>
