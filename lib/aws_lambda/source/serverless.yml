# For full config options, check the docs:
#    docs.serverless.com

service: resize-avatar

custom:
  bucket_suffix:
    dev: 'production-thumb'
    prod: 'production-thumb'
    partners-dev: 'production-thumb'
    partners-prod: 'production-thumb'
    pfp-dev: 'production-thumb'
    pfp-prod: 'production-thumb'
  dir_prefix:
    dev: 'staging/'
    prod: ''
    partners-dev: 'partners/staging/'
    partners-prod: 'partners/'
    pfp-dev: 'pfp/staging/'
    pfp-prod: 'pfp/'

provider:
  name: aws
  runtime: nodejs10.x
  stage: ${opt:stage, 'dev'}
  region: eu-west-1
  logRetentionInDays: 30
  environment :
    watch_bucket: "entourage-avatars-production-thumb"
    watch_dir: "${self:custom.dir_prefix.${self:provider.stage}}300x300/"
    target_bucket: "entourage-avatars-${self:custom.bucket_suffix.${self:provider.stage}}"
    target_width: 300
    target_height: 300
    target_small_width: 60
    target_small_height: 60
    target_dir: "${self:custom.dir_prefix.${self:provider.stage}}300x300/"
    target_small_dir: "${self:custom.dir_prefix.${self:provider.stage}}60x60/"
    source_dir: "${self:custom.dir_prefix.${self:provider.stage}}source/"
    request_string: ${self:functions.resize-avatar.name}
  event-landscape-environment:
    watch_bucket: "entourage-avatars-production-thumb"
    watch_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/landscape/"
    target_bucket: "entourage-avatars-${self:custom.bucket_suffix.${self:provider.stage}}"
    target_width: 1125
    target_height: 375
    target_small_width: 375
    target_small_height: 125
    target_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/landscape/1125x375/"
    target_small_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/landscape/375x125/"
    source_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/landscape/source/"
    request_string: ${self:functions.add-event-landscape.name}
  event-portrait-environment:
    watch_bucket: "entourage-avatars-production-thumb"
    watch_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/portrait/"
    target_bucket: "entourage-avatars-${self:custom.bucket_suffix.${self:provider.stage}}"
    target_width: 375
    target_height: 192
    target_small_width: 125
    target_small_height: 64
    target_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/portrait/375x192/"
    target_small_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/portrait/125x64/"
    source_dir: "${self:custom.dir_prefix.${self:provider.stage}}entourage_images/portrait/source/"
    request_string: ${self:functions.add-event-portrait.name}

  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:*
      Resource: "*"

functions:
  resize-avatar:
    name: resize-avatar-${self:provider.stage}
    handler: handler.resizeImage
    events:
      - s3:
          bucket: ${self:provider.environment.watch_bucket}
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - prefix: ${self:provider.environment.watch_dir}
  add-event-landscape:
    name: add-event-landscape-${self:provider.stage}
    handler: handler.resizeImage
    events:
      - s3:
          bucket: ${self:provider.environment.watch_bucket}
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - prefix: ${self:provider.environment.watch_dir}

  add-event-portrait:
    name: add-event-portrait-${self:provider.stage}
    handler: handler.resizeImage
    events:
      - s3:
          bucket: ${self:provider.environment.watch_bucket}
          event: s3:ObjectCreated:*
          existing: true
          rules:
            - prefix: ${self:provider.environment.watch_dir}
